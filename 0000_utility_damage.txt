/* Plugin generated by AMXX-Studio */

#include <amxmodx>
#include <amxmisc>
#include <engine>
#include <fakemeta>
#include <hamsandwich>
#include <zp50_core>

#define PLUGIN "New Utility Damage"
#define VERSION "1.0"
#define AUTHOR "Administrator"
new Float:ivecOrigin[33][3]
new iDistance_Cvar, Dm_cvar
public plugin_init() {
	register_plugin(PLUGIN, VERSION, AUTHOR)
	RegisterHam(Ham_TakeDamage, "info_target", "fw_TakeDamage");	
	RegisterHam(Ham_TakeDamage, "func_wall", "fw_TakeDamage");
	RegisterHam(Ham_TakeDamage, "func_breakable", "fw_TakeDamage");	
	
	iDistance_Cvar = register_cvar("zp_utility_dist","128.0")
	Dm_cvar = register_cvar("zp_utility_dm","2.5")
}

public fw_TakeDamage(victim, inflictor, attacker, Float:damage)
{
	if(is_user_connected(victim))
	{
	}
	else
	{
		new sz_classname[32] 
		entity_get_string( victim , EV_SZ_classname , sz_classname, 31 )			
		if(equali(sz_classname,"lasermine") ) 
		{
		}
		else
		if(equali(sz_classname,"amxx_pallets"))
		{
		}
		else
		if(equali(sz_classname,"rcbomb"))
		{
		}
		else
		if(equali(sz_classname,"amxx_mt"))
		{
		}
		else	
			return HAM_IGNORED; 
	}
	
	if(!is_user_alive(attacker))
		return HAM_IGNORED;
		
	if(victim == attacker)
		return HAM_IGNORED;
	
	if(!zp_core_is_zombie(attacker))
		return HAM_IGNORED;
	entity_get_vector(victim,EV_VEC_origin,ivecOrigin[attacker])
	new Float:Extra = float(CountUtility(attacker)) * get_pcvar_float(Dm_cvar)
	if(CountUtility(attacker)>5)
		SetHamParamFloat(4, damage+Extra)
	return HAM_IGNORED;
		
}

public CountUtility(id)
{
	static victim;
	new iCount = 0;
	victim = -1
	new Float:iDistance = get_pcvar_float(iDistance_Cvar)
	while ( ( victim = find_ent_in_sphere(victim,ivecOrigin[id],iDistance)) != 0 )
	{	
		if(pev_valid(victim))
		{
			static classname[32]
			entity_get_string(victim,EV_SZ_classname,classname,charsmax(classname))
			if(equali(classname,"amxx_pallets"))
				iCount++
			if(equali(classname,"lasermine"))
				iCount++
			if(equali(classname,"amxx_mt"))
				iCount++
		}
	}
	return iCount;
}